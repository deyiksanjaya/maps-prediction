<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>Maps Prediction by Heri Sanjaya</title>
    
    <!-- PWA & Mobile Optimization Meta Tags -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#ffffff">

    <!-- iOS Specific Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Prediksi Sulap">
    <link rel="apple-touch-icon" href="https://img.icons8.com/external-flaticons-lineal-color-flat-icons/180/external-magic-hat-circus-flaticons-lineal-color-flat-icons.png">
    
    <!-- Fonts and Styles -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
    <style>
        html, body {
            width: 100%;
            height: 100%;
            overflow: hidden;
            overscroll-behavior: none;
        }
        body {
            font-family: 'Inter', sans-serif;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
            -webkit-user-select: none;
        }
        .content-container {
            transition: opacity 0.2s ease-in-out;
        }
        .content-container.fade-out {
            opacity: 0;
        }
        .modal {
            z-index: 50;
        }
        #notification-modal {
            transition: opacity 0.3s ease-in-out;
        }
        .modal-content-area::-webkit-scrollbar { width: 8px; }
        .modal-content-area::-webkit-scrollbar-track { background: #f1f1f1; }
        .modal-content-area::-webkit-scrollbar-thumb { background: #a8a8a8; border-radius: 4px; }

        #image-editor-canvas-area {
          touch-action: none;
        }
        #editor-overlay-text {
          user-select: none;
          pointer-events: none;
        }
        #editor-text-boundary-box {
            box-sizing: border-box;
        }
    </style>
</head>
<body class="bg-white text-black">

    <div class="absolute top-4 left-4 right-4 flex justify-between z-20">
        <button id="open-settings-btn" class="p-2 rounded-full hover:bg-gray-200 transition-colors">
            <img src="https://img.icons8.com/ios-glyphs/30/000000/settings.png" alt="Pengaturan" class="w-6 h-6"/>
        </button>
        <button id="open-instructions-btn" class="p-2 rounded-full hover:bg-gray-200 transition-colors">
            <img src="https://img.icons8.com/ios-glyphs/30/000000/question-mark.png" alt="Instruksi" class="w-6 h-6"/>
        </button>
    </div>

    <main class="w-full h-full flex flex-col items-center justify-center">
        <!-- Grid View -->
        <div id="grid-view-container" class="relative w-[85vw] h-[85vw] max-w-[500px] max-h-[500px] sm:w-[70vh] sm:h-[70vh] border-2 border-black">
            <div class="absolute inset-0 pointer-events-none">
                <div class="absolute top-0 left-1/2 -translate-x-1/2 w-0.5 h-[33%] bg-black"></div>
                <div class="absolute bottom-0 left-1/2 -translate-x-1/2 w-0.5 h-[33%] bg-black"></div>
                <div class="absolute left-0 top-1/2 -translate-y-1/2 h-0.5 w-[33%] bg-black"></div>
                <div class="absolute right-0 top-1/2 -translate-y-1/2 h-0.5 w-[33%] bg-black"></div>
            </div>
            <div class="absolute inset-0 grid grid-cols-2 grid-rows-2">
                <div data-index="0" class="clickable-area cursor-pointer relative flex items-center justify-center p-2 text-center"></div>
                <div data-index="1" class="clickable-area cursor-pointer relative flex items-center justify-center p-2 text-center"></div>
                <div data-index="2" class="clickable-area cursor-pointer relative flex items-center justify-center p-2 text-center"></div>
                <div data-index="3" class="clickable-area cursor-pointer relative flex items-center justify-center p-2 text-center"></div>
            </div>
            <div data-index="4" class="clickable-area absolute top-1/2 left-1/2 w-[34%] h-[34%] border-2 border-black cursor-pointer transform -translate-x-1/2 -translate-y-1/2 flex items-center justify-center p-2 text-center"></div>
        </div>
        
        <div id="message-area" class="mt-8 h-10 text-center flex flex-col items-center justify-center">
            <p id="message-text" class="text-lg text-gray-500">Memuat...</p>
        </div>
    </main>

    <!-- Settings Modal -->
    <div id="settings-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 sm:p-8 modal">
        <div class="bg-white border border-black rounded-lg shadow-xl w-full max-w-md flex flex-col text-black max-h-[90vh]">
            <div class="p-4 border-b border-gray-300 flex justify-between items-center flex-shrink-0">
                <h2 class="text-xl font-bold">Pengaturan Rahasia</h2>
                <button id="close-settings-modal-btn" class="p-1 rounded-full hover:bg-gray-200">
                    <img src="https://img.icons8.com/ios-filled/24/000000/delete-sign.png" alt="Tutup" class="w-5 h-5"/>
                </button>
            </div>
            
            <div class="overflow-y-auto modal-content-area">
                <div class="p-4 border-b border-gray-300">
                    <h3 class="font-semibold mb-2">Buka Prediksi di:</h3>
                    <div class="flex flex-col space-y-2">
                        <label class="flex items-center"><input type="radio" name="searchEngine" value="maps" class="mr-2"> Google Maps</label>
                        <label class="flex items-center"><input type="radio" name="searchEngine" value="google" class="mr-2"> Google Search</label>
                        <label class="flex items-center"><input type="radio" name="searchEngine" value="shortcut" class="mr-2"> Shortcut iOS</label>
                        <label class="flex items-center"><input type="radio" name="searchEngine" value="gallery" class="mr-2"> Galeri (Mode Preview)</label>
                    </div>
                    <div id="shortcut-name-container" class="hidden mt-3">
                        <label for="shortcut-name-input" class="block font-medium text-sm mb-1">Nama Shortcut</label>
                        <input type="text" id="shortcut-name-input" placeholder="Contoh: Proses Prediksi" class="w-full bg-gray-100 border border-gray-300 rounded px-3 py-2">
                    </div>
                </div>

                <div class="p-4 border-y border-gray-300 space-y-3">
                    <label for="bulk-add-input" class="block font-medium text-sm mb-1">Daftar Item Prediksi (pisahkan dengan koma)</label>
                    <textarea id="bulk-add-input" rows="8" placeholder="Jakarta, Bandung, Surabaya, ..." class="w-full bg-gray-100 border border-gray-300 rounded px-3 py-2"></textarea>
                </div>

                <div class="p-4 space-y-3">
                     <h3 class="font-semibold mb-2">Pengaturan Gambar</h3>
                     <button id="go-to-image-editor-btn" class="w-full bg-indigo-600 text-white py-2 px-4 rounded hover:bg-indigo-500">Atur Prediksi Gambar</button>
                </div>

            </div>

            <div class="p-4 border-t border-gray-300 flex-shrink-0">
                <button id="save-btn" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 px-4 rounded transition-colors">
                    Simpan Perubahan
                </button>
            </div>
        </div>
    </div>

    <!-- IMAGE EDITOR VIEW -->
    <div id="image-editor-view" class="hidden fixed inset-0 bg-gray-900 z-40 flex flex-col">
        <div class="p-2 bg-gray-800 text-white flex justify-between items-center flex-shrink-0">
            <h2 class="font-bold">Editor Prediksi Gambar</h2>
            <button id="save-and-return-btn" class="bg-blue-600 hover:bg-blue-500 text-white font-bold py-1 px-3 rounded text-sm">Simpan & Kembali</button>
        </div>

        <div id="image-editor-canvas-area" class="relative flex-grow flex items-center justify-center p-2 overflow-hidden">
             <img id="editor-base-image" src="https://placehold.co/600x400/1f2937/9ca3af?text=Pilih+Gambar" alt="Editor Preview" class="max-w-full max-h-full block object-contain pointer-events-none">
             <div id="editor-text-boundary-box" class="absolute border-2 border-dashed border-cyan-400 pointer-events-none" style="display: none;"></div>
             <div id="editor-overlay-text" class="absolute font-bold flex items-center justify-center text-center" style="display: none;">
               Contoh Teks
             </div>
        </div>
        
        <!-- Hidden helper for text measurement -->
        <div id="text-measure-helper" class="absolute font-bold text-center" style="visibility: hidden; top: -1000px; left: -1000px; word-break: break-word;"></div>

        <div id="image-editor-controls" class="flex-shrink-0 bg-gray-800 text-white p-4 overflow-y-auto max-h-[40vh]">
             <div class="grid grid-cols-2 gap-x-4 gap-y-3 text-sm max-w-lg mx-auto">
                <div class="col-span-2">
                    <label id="editor-image-upload-btn" for="editor-image-upload-input" class="block w-full text-center bg-gray-600 text-white py-2 px-4 rounded hover:bg-gray-500 transition-colors cursor-pointer">
                        Pilih Gambar Latar
                    </label>
                    <input type="file" id="editor-image-upload-input" accept="image/*" class="hidden">
                </div>

                <div class="col-span-2">
                  <button id="editor-set-position-btn" class="w-full bg-cyan-600 text-white py-2 px-4 rounded hover:bg-cyan-500">Atur Posisi Teks</button>
                </div>

                <div class="col-span-2">
                  <label for="editor-overlay-input" class="block font-medium">Teks Overlay (Default)</label>
                  <input type="text" id="editor-overlay-input" placeholder="Tulis teks overlay" class="w-full border px-3 py-2 rounded bg-gray-700 text-white border-gray-600">
                </div>
                
                <div>
                    <label for="editor-font-size" class="block font-medium">Ukuran</label>
                    <input type="range" id="editor-font-size" min="10" max="200" value="100" class="w-full">
                </div>
                <div>
                    <label for="editor-rotation" class="block font-medium">Rotasi</label>
                    <input type="range" id="editor-rotation" min="-180" max="180" value="0" class="w-full">
                </div>

                <div>
                    <label for="editor-opacity" class="block font-medium">Opacity</label>
                    <input type="range" id="editor-opacity" min="0" max="1" step="0.05" value="1" class="w-full">
                </div>
                 <div>
                    <label for="editor-color" class="block font-medium">Warna</label>
                    <input type="color" id="editor-color" value="#ffffff" class="w-full h-8 border-none p-0 rounded cursor-pointer bg-gray-700">
                </div>
                
                <div>
                    <label for="editor-brightness" class="block font-medium">Brightness</label>
                    <input type="range" id="editor-brightness" min="0" max="200" value="100" class="w-full">
                </div>
                <div>
                    <label for="editor-contrast" class="block font-medium">Contrast</label>
                    <input type="range" id="editor-contrast" min="0" max="200" value="100" class="w-full">
                </div>
              </div>
        </div>
    </div>
    
    <!-- Instructions Modal -->
    <div id="instructions-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 sm:p-8 modal">
       <div class="bg-white border border-black rounded-lg shadow-xl w-full max-w-md flex flex-col text-black max-h-[90vh]">
            <div class="p-4 border-b border-gray-300 flex justify-between items-center flex-shrink-0">
                <h2 class="text-xl font-bold">Panduan</h2>
                <button id="close-instructions-modal-btn" class="p-1 rounded-full hover:bg-gray-200">
                    <img src="https://img.icons8.com/ios-filled/24/000000/delete-sign.png" alt="Tutup" class="w-5 h-5"/>
                </button>
            </div>
             <div class="p-6 space-y-4 overflow-y-auto modal-content-area">
                <div>
                    <h3 class="font-semibold text-lg mb-2">Efek</h3>
                    <p class="text-sm">Anda memulai dengan berkata, "Saya sudah punya satu prediksi di Google Maps." Setelah penonton menyebutkan satu lokasi secara bebas, Anda menunjukkan layar ponsel Anda, dan ternyata Google Maps menampilkan lokasi yang sama persis dengan yang baru saja mereka sebutkan.</p>
                </div>
                
                <div>
                    <h4 class="font-semibold text-md mt-4 mb-2">Metode Rahasia (Mode Galeri)</h4>
                    <ol class="list-decimal list-inside space-y-3 text-sm mt-3">
                         <li>
                            <strong>Input Rahasia:</strong> Saat penonton menyebutkan pilihan, Anda melakukan input rahasia seperti biasa di grid.
                        </li>
                        <li>
                            <strong>Munculkan Preview:</strong> Layar akan menjadi hitam dan menampilkan gambar prediksi yang sudah jadi (gambar + teks).
                        </li>
                        <li>
                            <strong>Simpan/Bagikan:</strong> Tekan dan tahan gambar preview untuk memunculkan menu "Share" dari ponsel Anda. Dari sana Anda bisa menyimpannya ke galeri atau mengirimnya ke aplikasi lain.
                        </li>
                        <li>
                            <strong>Tutup Preview:</strong> Ketuk dua kali (double tap) di area hitam di luar gambar untuk kembali ke layar grid.
                        </li>
                    </ol>
                </div>
            </div>
        </div>
    </div>

    <!-- Notification Modal -->
    <div id="notification-modal" class="hidden fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-black bg-opacity-80 text-white text-center p-6 rounded-lg z-60">
        <p id="notification-text" class="font-semibold"></p>
    </div>

    <!-- Preview Overlay -->
    <div id="preview-overlay" class="hidden fixed inset-0 bg-black flex items-center justify-center z-50">
        <img id="preview-image" src="" alt="Preview Prediksi" class="max-w-full max-h-full object-contain shadow-2xl">
    </div>

    <div class="absolute bottom-4 left-0 right-0 text-center italic text-xs text-gray-400 pointer-events-none">
        concepted by Heri Sanjaya
    </div>

    <script>
        // if ('serviceWorker' in navigator) {
        //     window.addEventListener('load', () => navigator.serviceWorker.register('service-worker.js'));
        // }

        document.addEventListener('DOMContentLoaded', () => {
            const STORAGE_KEY = 'magicAppDataV8_GridOnly_Bali_v5'; 

            const defaultData = {
                settings: { 
                    searchEngine: 'maps', 
                    shortcutName: '',
                },
                pages: [ 
                    { startNumber: 1, regions: ['Pantai Kuta', 'Seminyak', 'Canggu', 'Garuda Wisnu Kencana', 'Pura Uluwatu'] },
                    { startNumber: 6, regions: ['Ubud', 'Sawah Terasering Tegalalang', 'Danau Beratan Bedugul', 'Tanah Lot', 'Pantai Lovina'] },
                    { startNumber: 11, regions: ['Nusa Dua', 'Sanur', 'Jimbaran', 'Gunung Batur', 'Tirta Empul'] }
                ],
                overlaySettings: {
                    text: 'Contoh Teks',
                    fontSizeScale: 1, 
                    color: '#ffffff', opacity: '1', rotation: '0',
                    boundary: null, 
                    brightness: '100', contrast: '100', 
                    baseImage: "https://placehold.co/600x400/1f2937/9ca3af?text=Pilih+Gambar"
                }
            };
            
            // --- Elements ---
            const mainView = document.querySelector('main');
            const openSettingsBtn = document.getElementById('open-settings-btn');
            const settingsModal = document.getElementById('settings-modal');
            const closeSettingsModalBtn = document.getElementById('close-settings-modal-btn');
            const saveBtn = document.getElementById('save-btn');
            const openInstructionsBtn = document.getElementById('open-instructions-btn');
            const instructionsModal = document.getElementById('instructions-modal');
            const closeInstructionsModalBtn = document.getElementById('close-instructions-modal-btn');
            const searchEngineRadios = document.querySelectorAll('input[name="searchEngine"]');
            const shortcutNameContainer = document.getElementById('shortcut-name-container');
            const shortcutNameInput = document.getElementById('shortcut-name-input');
            const bulkAddInput = document.getElementById('bulk-add-input');
            const notificationModal = document.getElementById('notification-modal');
            const notificationText = document.getElementById('notification-text');
            const previewOverlay = document.getElementById('preview-overlay');
            const previewImage = document.getElementById('preview-image');
            const goToImageEditorBtn = document.getElementById('go-to-image-editor-btn');

            // --- Image Editor Elements ---
            const imageEditorView = document.getElementById('image-editor-view');
            const saveAndReturnBtn = document.getElementById('save-and-return-btn');
            const editorCanvasArea = document.getElementById('image-editor-canvas-area');
            const editorBaseImage = document.getElementById('editor-base-image');
            const editorImageUploadBtn = document.getElementById('editor-image-upload-btn');
            const editorImageUploadInput = document.getElementById('editor-image-upload-input');
            const editorOverlayText = document.getElementById('editor-overlay-text');
            const editorOverlayInput = document.getElementById('editor-overlay-input');
            const editorFontSize = document.getElementById('editor-font-size');
            const editorRotation = document.getElementById('editor-rotation');
            const editorColor = document.getElementById('editor-color');
            const editorOpacity = document.getElementById('editor-opacity');
            const editorBrightness = document.getElementById('editor-brightness');
            const editorContrast = document.getElementById('editor-contrast');
            const editorSetPositionBtn = document.getElementById('editor-set-position-btn');
            const editorTextBoundaryBox = document.getElementById('editor-text-boundary-box');
            const textMeasureHelper = document.getElementById('text-measure-helper');

            let appData = {};
            let currentPageIndex = 0;
            let setPageIndex = 0;
            let isSetSelectionMode = true;
            let isSingleItemMode = false;

            function executeAction(regionName) {
                const { searchEngine, shortcutName } = appData.settings;
                
                if (searchEngine === 'gallery') {
                    showPreview(regionName);
                    return;
                }

                let url = '';
                if (searchEngine === 'shortcut') {
                    if (!shortcutName) { showNotification('Nama Shortcut belum diatur!'); return; }
                    url = `shortcuts://run-shortcut?name=${encodeURIComponent(shortcutName)}&input=${encodeURIComponent(regionName)}`; 
                } else {
                    url = (searchEngine === 'maps') ? `https://maps.google.com/?q=${encodeURIComponent(regionName)}` : `https://www.google.com/search?q=${encodeURIComponent(regionName)}`;
                }
                openInExternalBrowser(url);
                document.getElementById('message-text').textContent = `Membuka Prediksi: ${capitalizeFirstLetter(regionName)}`;
                document.getElementById('message-text').classList.remove('hidden');
                setTimeout(() => document.getElementById('message-text').classList.add('hidden'), 2500);
            }
            
            function capitalizeFirstLetter(string) {
                if (!string) return '';
                return string.charAt(0).toUpperCase() + string.slice(1);
            }

            function openInExternalBrowser(url) {
                const a = document.createElement('a'); a.href = url; a.target = '_blank';
                a.rel = 'noopener noreferrer'; document.body.appendChild(a); a.click(); document.body.removeChild(a);
            }

            function loadDataFromStorage() {
                const storedData = localStorage.getItem(STORAGE_KEY);
                try {
                    const parsedData = JSON.parse(storedData);
                    if (parsedData && parsedData.settings && parsedData.pages) {
                        return {
                            ...defaultData, ...parsedData,
                            settings: { ...defaultData.settings, ...parsedData.settings },
                            overlaySettings: { ...defaultData.overlaySettings, ...parsedData.overlaySettings }
                        };
                    }
                    return defaultData;
                } catch (e) { return defaultData; }
            }

            function saveDataToStorage() { localStorage.setItem(STORAGE_KEY, JSON.stringify(appData)); }
            
            function updateGridView() {
                if (!appData.pages || appData.pages.length === 0) return;
                isSingleItemMode = appData.pages.length === 1 && appData.pages[0].regions.length === 1;
                if (isSingleItemMode) {
                    document.getElementById('message-text').classList.add('hidden');
                    const regionName = appData.pages[0].regions[0];
                    const singleItemHTML = `<div class="content-container w-full h-full flex items-center justify-center text-center"><span class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-black opacity-10 text-6xl sm:text-8xl font-black z-0">1</span><span class="relative z-10 font-semibold text-xl sm:text-3xl">${capitalizeFirstLetter(regionName)}</span></div>`;
                    document.querySelectorAll('.clickable-area').forEach(area => { area.innerHTML = singleItemHTML; });
                } else if (isSetSelectionMode) {
                    document.getElementById('message-text').textContent = "Pilih Grup Prediksi";
                    document.getElementById('message-text').classList.remove('hidden');
                    const setsPerPage = 5;
                    const startIndex = setPageIndex * setsPerPage;
                    document.querySelectorAll('.clickable-area').forEach((area, index) => {
                        const page = appData.pages[startIndex + index];
                        if (page && page.regions.length > 0) {
                            const start = page.startNumber; const end = start + page.regions.length - 1;
                             area.innerHTML = `<div class="content-container w-full h-full flex items-center justify-center text-center"><span class="relative z-10 font-black text-3xl sm:text-5xl">${start}-${end}</span></div>`;
                        } else { area.innerHTML = ''; }
                    });
                } else {
                    const currentPage = appData.pages[currentPageIndex];
                    if (!currentPage) { isSetSelectionMode = true; updateGridView(); return; }
                    document.getElementById('message-text').classList.add('hidden');
                    document.querySelectorAll('.clickable-area').forEach((area, index) => {
                        const regionName = currentPage.regions[index] || '';
                        const formattedName = capitalizeFirstLetter(regionName);
                        area.innerHTML = regionName ? `<div class="content-container w-full h-full flex items-center justify-center text-center"><span class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-black opacity-10 text-6xl sm:text-8xl font-black z-0">${currentPage.startNumber + index}</span><span class="relative z-10 font-semibold text-base sm:text-xl">${formattedName}</span></div>` : '';
                    });
                }
            }
            
            function showNotification(message) {
                notificationText.innerHTML = message;
                notificationModal.classList.remove('hidden', 'opacity-0');
                setTimeout(() => {
                    notificationModal.classList.add('opacity-0');
                    setTimeout(() => notificationModal.classList.add('hidden'), 2000);
                }, 1500);
            }

            function populateSettingsModal() {
                document.querySelector(`input[name="searchEngine"][value="${appData.settings.searchEngine}"]`).checked = true;
                shortcutNameInput.value = appData.settings.shortcutName || '';
                shortcutNameContainer.classList.toggle('hidden', appData.settings.searchEngine !== 'shortcut');
                const allRegions = appData.pages.flatMap(page => page.regions);
                bulkAddInput.value = allRegions.join(', ');
            }
            
            // --- Event Listeners ---
            openSettingsBtn.addEventListener('click', () => { populateSettingsModal(); settingsModal.classList.remove('hidden'); });
            closeSettingsModalBtn.addEventListener('click', () => settingsModal.classList.add('hidden'));
            openInstructionsBtn.addEventListener('click', () => instructionsModal.classList.remove('hidden'));
            closeInstructionsModalBtn.addEventListener('click', () => instructionsModal.classList.add('hidden'));
            
            searchEngineRadios.forEach(radio => radio.addEventListener('change', (e) => {
                shortcutNameContainer.classList.toggle('hidden', e.target.value !== 'shortcut');
            }));

            saveBtn.addEventListener('click', () => {
                appData.settings.searchEngine = document.querySelector('input[name="searchEngine"]:checked').value;
                appData.settings.shortcutName = shortcutNameInput.value.trim();
                const allRegions = bulkAddInput.value.split(',').map(item => item.trim()).filter(Boolean);
                const newPages = [];
                let currentStartNumber = 1;
                for (let i = 0; i < allRegions.length; i += 5) {
                    newPages.push({ startNumber: currentStartNumber, regions: allRegions.slice(i, i + 5) });
                    currentStartNumber += allRegions.slice(i, i + 5).length;
                }
                appData.pages = (newPages.length > 0) ? newPages : [{ startNumber: 1, regions: ['Item Contoh'] }];
                saveDataToStorage();
                isSetSelectionMode = true; 
                setPageIndex = 0;
                updateGridView();
                settingsModal.classList.add('hidden');
                showNotification("Perubahan disimpan!");
            });

            document.getElementById('grid-view-container').addEventListener('click', (event) => {
                const area = event.target.closest('.clickable-area');
                if (!area) return;
                const areaIndexOnScreen = parseInt(area.dataset.index);
                let regionName;
                if (isSingleItemMode) {
                    regionName = appData.pages[0].regions[0];
                } else if (isSetSelectionMode) {
                    const actualSetIndex = (setPageIndex * 5) + areaIndexOnScreen;
                    if (appData.pages[actualSetIndex]) { 
                        currentPageIndex = actualSetIndex; isSetSelectionMode = false; changePage(); 
                    }
                    return;
                } else {
                    regionName = appData.pages[currentPageIndex]?.regions[areaIndexOnScreen];
                }
                if (regionName) executeAction(regionName);
            });

            let touchStartX = 0;
            document.getElementById('grid-view-container').addEventListener('touchstart', (e) => { touchStartX = e.changedTouches[0].screenX; }, { passive: true });
            document.getElementById('grid-view-container').addEventListener('touchend', (e) => {
                if (isSingleItemMode) return;
                const deltaX = e.changedTouches[0].screenX - touchStartX; 
                const swipeThreshold = 50;
                if (isSetSelectionMode) {
                    const maxSetPageIndex = Math.ceil(appData.pages.length / 5) - 1;
                    if (deltaX < -swipeThreshold && setPageIndex < maxSetPageIndex) { setPageIndex++; changePage(); } 
                    else if (deltaX > swipeThreshold && setPageIndex > 0) { setPageIndex--; changePage(); }
                } else {
                    if (deltaX < -swipeThreshold && currentPageIndex < appData.pages.length - 1) { currentPageIndex++; changePage(); } 
                    else if (deltaX > swipeThreshold) { isSetSelectionMode = true; setPageIndex = Math.floor(currentPageIndex / 5); changePage(); }
                }
            });

            function changePage() {
                document.querySelectorAll('.content-container').forEach(el => el.classList.add('fade-out'));
                setTimeout(() => { updateGridView(); }, 200);
            }

            // --- OVERLAY EDITOR ---
            let editorMode = 'idle'; // 'idle' or 'positioning'
            let isDragging = false;
            let dragStartX, dragStartY;

            function getEditorRenderedImageRect() {
                const img = editorBaseImage;
                const container = editorCanvasArea;
                const { naturalWidth, naturalHeight } = img;
                if (!naturalWidth || !naturalHeight) return container.getBoundingClientRect();
                const { width: containerWidth, height: containerHeight } = container.getBoundingClientRect();
                const imgRatio = naturalWidth / naturalHeight;
                const containerRatio = containerWidth / containerHeight;
                let renderedWidth, renderedHeight;
                if (imgRatio > containerRatio) {
                    renderedWidth = containerWidth;
                    renderedHeight = renderedWidth / imgRatio;
                } else {
                    renderedHeight = containerHeight;
                    renderedWidth = renderedHeight * imgRatio;
                }
                const containerRect = container.getBoundingClientRect();
                 return {
                    width: renderedWidth, height: renderedHeight,
                    left: containerRect.left + (containerWidth - renderedWidth) / 2, 
                    top: containerRect.top + (containerHeight - renderedHeight) / 2
                };
            }

            function updateEditorOverlayStyle(boundaryOverride = null) {
                const s = appData.overlaySettings;
                const boundary = boundaryOverride || s.boundary;

                if (!boundary) {
                    editorOverlayText.style.display = 'none';
                    editorTextBoundaryBox.style.display = 'none';
                    return;
                }
                
                editorOverlayText.style.display = 'flex';
                editorTextBoundaryBox.style.display = 'block';
                
                const renderedRect = getEditorRenderedImageRect();
                const imageOffsetX = renderedRect.left - editorCanvasArea.getBoundingClientRect().left;
                const imageOffsetY = renderedRect.top - editorCanvasArea.getBoundingClientRect().top;

                editorTextBoundaryBox.style.left = `${imageOffsetX + (boundary.x * renderedRect.width)}px`;
                editorTextBoundaryBox.style.top = `${imageOffsetY + (boundary.y * renderedRect.height)}px`;
                editorTextBoundaryBox.style.width = `${boundary.width * renderedRect.width}px`;
                editorTextBoundaryBox.style.height = `${boundary.height * renderedRect.height}px`;

                const boundaryWidthPx = boundary.width * renderedRect.width;
                const boundaryHeightPx = boundary.height * renderedRect.height;
                
                const xPos = imageOffsetX + boundary.x * renderedRect.width + boundaryWidthPx / 2;
                const yPos = imageOffsetY + boundary.y * renderedRect.height + boundaryHeightPx / 2;
                
                editorOverlayText.style.width = `${boundaryWidthPx}px`;
                editorOverlayText.style.height = `${boundaryHeightPx}px`;
                editorOverlayText.style.transform = `translate(-50%, -50%) translate(${xPos}px, ${yPos}px) rotate(${s.rotation}deg)`;
                
                textMeasureHelper.style.width = `${boundaryWidthPx}px`;
                textMeasureHelper.textContent = s.text;
                
                let fontSize = boundaryHeightPx;
                 while (fontSize > 8) {
                    textMeasureHelper.style.fontSize = `${fontSize}px`;
                    if (textMeasureHelper.scrollHeight <= boundaryHeightPx * 1.05) { 
                        break;
                    }
                    fontSize -= 2;
                }

                editorOverlayText.style.fontSize = `${fontSize * (s.fontSizeScale || 1)}px`;
                editorOverlayText.style.color = s.color;
                editorOverlayText.style.opacity = s.opacity;
                editorOverlayText.style.filter = `brightness(${s.brightness}%) contrast(${s.contrast}%)`;
                editorOverlayText.textContent = s.text;
                editorOverlayText.style.wordBreak = 'break-word';
            }

            function loadEditorSettings() {
                const s = appData.overlaySettings || defaultData.overlaySettings;
                editorBaseImage.src = s.baseImage;
                editorOverlayInput.value = s.text;
                editorFontSize.value = (s.fontSizeScale || 1) * 100;
                editorRotation.value = s.rotation;
                editorColor.value = s.color;
                editorOpacity.value = s.opacity;
                editorBrightness.value = s.brightness;
                editorContrast.value = s.contrast;
                editorBaseImage.onload = () => updateEditorOverlayStyle();
                updateEditorOverlayStyle();
            }

            function saveEditorSettings() {
                appData.overlaySettings = {
                    ...appData.overlaySettings,
                    text: editorOverlayInput.value, 
                    fontSizeScale: parseFloat(editorFontSize.value) / 100,
                    color: editorColor.value,
                    opacity: editorOpacity.value, 
                    rotation: editorRotation.value,
                    brightness: editorBrightness.value, 
                    contrast: editorContrast.value,
                };
            }
            
            function onPositioningDragStart(e) {
                if (editorMode !== 'positioning' || (e.type === 'mousedown' && e.button !== 0)) return;
                e.preventDefault();
                isDragging = true;
                const currentX = e.type === 'touchstart' ? e.touches[0].clientX : e.clientX;
                const currentY = e.type === 'touchstart' ? e.touches[0].clientY : e.clientY;
                dragStartX = currentX;
                dragStartY = currentY;
                const renderedRect = getEditorRenderedImageRect();
                const startX_pct = Math.max(0, Math.min(1, (dragStartX - renderedRect.left) / renderedRect.width));
                const startY_pct = Math.max(0, Math.min(1, (dragStartY - renderedRect.top) / renderedRect.height));
                const liveBoundary = { x: startX_pct, y: startY_pct, width: 0, height: 0 };
                updateEditorOverlayStyle(liveBoundary);
            }
            
            function onPositioningDragMove(e) {
                if (!isDragging || editorMode !== 'positioning') return;
                e.preventDefault();
                const currentX = e.type === 'touchmove' ? e.touches[0].clientX : e.clientX;
                const currentY = e.type === 'touchmove' ? e.touches[0].clientY : e.clientY;
                const renderedRect = getEditorRenderedImageRect();
                if (renderedRect.width === 0 || renderedRect.height === 0) return;

                const startX_pct = Math.max(0, Math.min(1, (dragStartX - renderedRect.left) / renderedRect.width));
                const startY_pct = Math.max(0, Math.min(1, (dragStartY - renderedRect.top) / renderedRect.height));
                const currentX_pct = Math.max(0, Math.min(1, (currentX - renderedRect.left) / renderedRect.width));
                const currentY_pct = Math.max(0, Math.min(1, (currentY - renderedRect.top) / renderedRect.height));
                
                const x = Math.min(startX_pct, currentX_pct);
                const y = Math.min(startY_pct, currentY_pct);
                const width = Math.abs(currentX_pct - startX_pct);
                const height = Math.abs(currentY_pct - startY_pct);
                
                const liveBoundary = { x, y, width, height };
                updateEditorOverlayStyle(liveBoundary);
            }

            function onPositioningDragEnd(e) {
                if (!isDragging || editorMode !== 'positioning') return;
                isDragging = false;
                
                const currentX = e.type === 'touchend' ? e.changedTouches[0].clientX : e.clientX;
                const currentY = e.type === 'touchend' ? e.changedTouches[0].clientY : e.clientY;
                const renderedRect = getEditorRenderedImageRect();
                if (renderedRect.width === 0 || renderedRect.height === 0) return;

                const startX_pct = Math.max(0, Math.min(1, (dragStartX - renderedRect.left) / renderedRect.width));
                const startY_pct = Math.max(0, Math.min(1, (dragStartY - renderedRect.top) / renderedRect.height));
                const currentX_pct = Math.max(0, Math.min(1, (currentX - renderedRect.left) / renderedRect.width));
                const currentY_pct = Math.max(0, Math.min(1, (currentY - renderedRect.top) / renderedRect.height));
                
                const x = Math.min(startX_pct, currentX_pct);
                const y = Math.min(startY_pct, currentY_pct);
                const width = Math.abs(currentX_pct - startX_pct);
                const height = Math.abs(currentY_pct - startY_pct);

                if (width > 0.01 && height > 0.01) {
                    appData.overlaySettings.boundary = { x, y, width, height };
                }
                updateEditorOverlayStyle();
            }
            
            async function showPreview(text) {
                showNotification("Membuat preview...");
                try {
                    const imageBlob = await generateCompositeImageAsBlob(text);
                    if (!imageBlob) return;
                    const imageUrl = URL.createObjectURL(imageBlob);
                    previewImage.src = imageUrl;
                    previewImage.onload = () => {
                        if (previewImage.dataset.previousUrl) URL.revokeObjectURL(previewImage.dataset.previousUrl);
                        previewImage.dataset.previousUrl = imageUrl;
                        previewOverlay.classList.remove('hidden');
                    };
                } catch (error) {
                    console.error("Gagal membuat preview:", error);
                    showNotification(error.message);
                }
            }
            
            function wrapAndFitText(ctx, text, maxWidth, maxHeight, baseFontSize) {
                let fontSize = baseFontSize;
                let lines = [];
                const words = text.split(' ');
                while (fontSize > 8) {
                    ctx.font = `bold ${fontSize}px 'Inter', sans-serif`;
                    lines = [];
                    let currentLine = words[0] || '';
                    for (let i = 1; i < words.length; i++) {
                        const word = words[i];
                        const width = ctx.measureText(currentLine + " " + word).width;
                        if (width < maxWidth) {
                            currentLine += " " + word;
                        } else {
                            lines.push(currentLine);
                            currentLine = word;
                        }
                    }
                    lines.push(currentLine);
                    const textMetrics = ctx.measureText('M');
                    const fontHeight = (textMetrics.fontBoundingBoxAscent || fontSize) + (textMetrics.fontBoundingBoxDescent || 0);
                    const totalHeight = lines.length * fontHeight;
                    if (totalHeight <= maxHeight) {
                        return { lines, fontSize, lineHeight: fontHeight };
                    }
                    fontSize -= 2;
                }
                return { lines, fontSize, lineHeight: (ctx.measureText('M').fontBoundingBoxAscent || fontSize) + (ctx.measureText('M').fontBoundingBoxDescent || 0) };
            }

            function generateCompositeImageAsBlob(text) {
                return new Promise((resolve, reject) => {
                    const settings = appData.overlaySettings;
                    if (!settings.boundary) return reject(new Error("Batas area teks belum diatur."));
                    
                    const img = new Image();
                    img.crossOrigin = "Anonymous";
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        canvas.width = img.naturalWidth;
                        canvas.height = img.naturalHeight;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        
                        const boundaryPx = {
                            x: settings.boundary.x * canvas.width,
                            y: settings.boundary.y * canvas.height,
                            width: settings.boundary.width * canvas.width,
                            height: settings.boundary.height * canvas.height,
                        };
                        
                        const baseFontSize = boundaryPx.height * (settings.fontSizeScale || 1);
                        const { lines, fontSize, lineHeight } = wrapAndFitText(ctx, text, boundaryPx.width * 0.95, boundaryPx.height * 0.95, baseFontSize);

                        ctx.fillStyle = settings.color;
                        ctx.globalAlpha = parseFloat(settings.opacity);
                        ctx.filter = `brightness(${settings.brightness}%) contrast(${settings.contrast}%)`;
                        ctx.textAlign = 'center';
                        ctx.textBaseline = 'middle';
                        ctx.font = `bold ${fontSize}px 'Inter', sans-serif`;
                        
                        const xPos = boundaryPx.x + boundaryPx.width / 2;
                        const yPos = boundaryPx.y + boundaryPx.height / 2;
                        const totalTextHeight = (lines.length - 1) * lineHeight;
                        const startYOffset = -totalTextHeight / 2;
                        
                        ctx.save();
                        ctx.translate(xPos, yPos);
                        ctx.rotate(parseFloat(settings.rotation) * Math.PI / 180);
                        for (let i = 0; i < lines.length; i++) {
                            ctx.fillText(lines[i], 0, startYOffset + (i * lineHeight));
                        }
                        ctx.restore();
                        
                        canvas.toBlob((blob) => {
                            if (blob) resolve(blob);
                            else reject(new Error("Gagal membuat gambar."));
                        }, 'image/png');
                    };
                    img.onerror = () => reject(new Error("Gagal memuat gambar untuk ekspor."));
                    img.src = settings.baseImage;
                });
            }

            function initializePreviewHandlers() {
                let lastTap = 0;
                previewOverlay.addEventListener('click', (e) => {
                     if (e.target !== previewImage) {
                         const currentTime = new Date().getTime();
                         const tapLength = currentTime - lastTap;
                         if (tapLength < 300 && tapLength > 0) previewOverlay.classList.add('hidden');
                         lastTap = currentTime;
                     }
                });
                let pressTimer;
                previewImage.addEventListener('touchstart', (e) => {
                    pressTimer = setTimeout(async () => {
                        try {
                            const blob = await fetch(previewImage.src).then(res => res.blob());
                            const filename = `prediksi-${appData.overlaySettings.text.replace(/\s+/g, '-').toLowerCase()}.png`;
                            const file = new File([blob], filename, { type: blob.type });
                            if (navigator.canShare && navigator.canShare({ files: [file] })) {
                                await navigator.share({ title: 'Prediksi Saya', files: [file] });
                            } else {
                                showNotification('Fitur share tidak didukung.');
                            }
                        } catch (err) {
                            if (err.name !== 'AbortError') showNotification('Gagal membagikan gambar.');
                        }
                    }, 700);
                }, { passive: true });
                const clearPressTimer = () => clearTimeout(pressTimer);
                previewImage.addEventListener('touchend', clearPressTimer);
                previewImage.addEventListener('touchmove', clearPressTimer);
            }

            function initializeEditor() {
                 ['input', 'change'].forEach(evt => {
                    const listener = () => { saveEditorSettings(); updateEditorOverlayStyle(); };
                    editorOverlayInput.addEventListener(evt, listener);
                    editorFontSize.addEventListener(evt, listener);
                    editorRotation.addEventListener(evt, listener);
                    editorColor.addEventListener(evt, listener);
                    editorOpacity.addEventListener(evt, listener);
                    editorBrightness.addEventListener(evt, listener);
                    editorContrast.addEventListener(evt, listener);
                });
                
                editorCanvasArea.addEventListener('mousedown', onPositioningDragStart);
                editorCanvasArea.addEventListener('touchstart', onPositioningDragStart, { passive: false });
                document.addEventListener('mousemove', onPositioningDragMove);
                document.addEventListener('touchmove', onPositioningDragMove, { passive: false });
                document.addEventListener('mouseup', onPositioningDragEnd);
                document.addEventListener('touchend', onPositioningDragEnd);

                editorSetPositionBtn.addEventListener('click', () => {
                    if (editorMode === 'idle') {
                        editorMode = 'positioning';
                        editorSetPositionBtn.textContent = "Selesai Menempatkan";
                        editorSetPositionBtn.classList.replace('bg-cyan-600', 'bg-red-500');
                        editorSetPositionBtn.classList.replace('hover:bg-cyan-500', 'hover:bg-red-400');
                        editorCanvasArea.style.cursor = 'crosshair';
                    } else {
                        editorMode = 'idle';
                        editorSetPositionBtn.textContent = "Atur Posisi Teks";
                        editorSetPositionBtn.classList.replace('bg-red-500', 'bg-cyan-600');
                        editorSetPositionBtn.classList.replace('hover:bg-red-400', 'hover:bg-cyan-500');
                        editorCanvasArea.style.cursor = 'default';
                        saveDataToStorage();
                    }
                    updateEditorOverlayStyle();
                });

                editorImageUploadInput.addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = (event) => {
                            const base64String = event.target.result;
                            editorBaseImage.src = base64String;
                            appData.overlaySettings.baseImage = base64String;
                            saveDataToStorage();
                            showNotification("Gambar latar diperbarui!");
                        };
                        reader.readAsDataURL(file);
                    }
                });
            }

            function toggleEditorView(show) {
                if (show) {
                    loadEditorSettings();
                    mainView.classList.add('hidden');
                    imageEditorView.classList.remove('hidden');
                } else {
                    saveEditorSettings();
                    saveDataToStorage();
                    imageEditorView.classList.add('hidden');
                    mainView.classList.remove('hidden');
                    settingsModal.classList.remove('hidden');
                }
            }

            // --- Initial Load ---
            goToImageEditorBtn.addEventListener('click', () => {
                settingsModal.classList.add('hidden');
                toggleEditorView(true);
            });
            saveAndReturnBtn.addEventListener('click', () => {
                toggleEditorView(false);
                updateGridView(); // Refresh grid view
                showNotification("Pengaturan gambar disimpan!");
            });
            
            appData = loadDataFromStorage();
            updateGridView();
            initializeEditor();
            initializePreviewHandlers();
        });
    </script>
</body>
</html>
