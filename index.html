<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>Maps Prediction by Heri Sanjaya</title>
    
    <!-- PWA & Mobile Optimization Meta Tags -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#ffffff">

    <!-- iOS Specific Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Prediksi Sulap">
    <link rel="apple-touch-icon" href="https://img.icons8.com/external-flaticons-lineal-color-flat-icons/180/external-magic-hat-circus-flaticons-lineal-color-flat-icons.png">
    
    <!-- Fonts and Styles -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
    <style>
        html, body {
            width: 100%;
            height: 100%;
            overflow: hidden;
            overscroll-behavior: none;
        }
        body {
            font-family: 'Inter', sans-serif;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
            -webkit-user-select: none;
        }
        .content-container {
            transition: opacity 0.2s ease-in-out;
        }
        .content-container.fade-out {
            opacity: 0;
        }
        .modal {
            z-index: 50;
        }
        #notification-modal {
            transition: opacity 0.3s ease-in-out;
        }
        .modal-content-area::-webkit-scrollbar { width: 8px; }
        .modal-content-area::-webkit-scrollbar-track { background: #f1f1f1; }
        .modal-content-area::-webkit-scrollbar-thumb { background: #a8a8a8; border-radius: 4px; }

        /* Added CSS for Overlay Editor */
        #overlay-editor-container {
          max-height: 250px;
          touch-action: none; /* Prevent scrolling on mobile while dragging */
        }
        #overlay-text {
          user-select: none;
          white-space: nowrap;
        }
    </style>
</head>
<body class="bg-white text-black">

    <div class="absolute top-4 left-4 right-4 flex justify-between z-20">
        <button id="open-settings-btn" class="p-2 rounded-full hover:bg-gray-200 transition-colors">
            <img src="https://img.icons8.com/ios-glyphs/30/000000/settings.png" alt="Pengaturan" class="w-6 h-6"/>
        </button>
        <button id="open-instructions-btn" class="p-2 rounded-full hover:bg-gray-200 transition-colors">
            <img src="https://img.icons8.com/ios-glyphs/30/000000/question-mark.png" alt="Instruksi" class="w-6 h-6"/>
        </button>
    </div>

    <main class="w-full h-full flex flex-col items-center justify-center">
        <!-- Grid View -->
        <div id="grid-view-container" class="relative w-[85vw] h-[85vw] max-w-[500px] max-h-[500px] sm:w-[70vh] sm:h-[70vh] border-2 border-black">
            <div class="absolute inset-0 pointer-events-none">
                <div class="absolute top-0 left-1/2 -translate-x-1/2 w-0.5 h-[33%] bg-black"></div>
                <div class="absolute bottom-0 left-1/2 -translate-x-1/2 w-0.5 h-[33%] bg-black"></div>
                <div class="absolute left-0 top-1/2 -translate-y-1/2 h-0.5 w-[33%] bg-black"></div>
                <div class="absolute right-0 top-1/2 -translate-y-1/2 h-0.5 w-[33%] bg-black"></div>
            </div>
            <div class="absolute inset-0 grid grid-cols-2 grid-rows-2">
                <div data-index="0" class="clickable-area cursor-pointer relative flex items-center justify-center p-2 text-center"></div>
                <div data-index="1" class="clickable-area cursor-pointer relative flex items-center justify-center p-2 text-center"></div>
                <div data-index="2" class="clickable-area cursor-pointer relative flex items-center justify-center p-2 text-center"></div>
                <div data-index="3" class="clickable-area cursor-pointer relative flex items-center justify-center p-2 text-center"></div>
            </div>
            <div data-index="4" class="clickable-area absolute top-1/2 left-1/2 w-[34%] h-[34%] border-2 border-black cursor-pointer transform -translate-x-1/2 -translate-y-1/2 flex items-center justify-center p-2 text-center"></div>
        </div>
        
        <div id="message-area" class="mt-8 h-10 text-center flex flex-col items-center justify-center">
            <p id="message-text" class="text-lg text-gray-500">Memuat...</p>
        </div>
    </main>

    <!-- Settings Modal -->
    <div id="settings-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 sm:p-8 modal">
        <div class="bg-white border border-black rounded-lg shadow-xl w-full max-w-md flex flex-col text-black max-h-[90vh]">
            <div class="p-4 border-b border-gray-300 flex justify-between items-center flex-shrink-0">
                <h2 class="text-xl font-bold">Pengaturan Rahasia</h2>
                <button id="close-settings-modal-btn" class="p-1 rounded-full hover:bg-gray-200">
                    <img src="https://img.icons8.com/ios-filled/24/000000/delete-sign.png" alt="Tutup" class="w-5 h-5"/>
                </button>
            </div>
            
            <div class="overflow-y-auto modal-content-area">
                <div class="p-4 border-b border-gray-300">
                    <h3 class="font-semibold mb-2">Buka Prediksi di:</h3>
                    <div class="flex flex-col space-y-2">
                        <label class="flex items-center"><input type="radio" name="searchEngine" value="maps" class="mr-2"> Google Maps</label>
                        <label class="flex items-center"><input type="radio" name="searchEngine" value="google" class="mr-2"> Google Search</label>
                        <label class="flex items-center"><input type="radio" name="searchEngine" value="shortcut" class="mr-2"> Shortcut iOS</label>
                        <label class="flex items-center"><input type="radio" name="searchEngine" value="gallery" class="mr-2"> Galeri (Export Otomatis)</label>
                    </div>
                    <div id="shortcut-name-container" class="hidden mt-3">
                        <label for="shortcut-name-input" class="block font-medium text-sm mb-1">Nama Shortcut</label>
                        <input type="text" id="shortcut-name-input" placeholder="Contoh: Proses Prediksi" class="w-full bg-gray-100 border border-gray-300 rounded px-3 py-2">
                    </div>
                </div>

                <div class="p-4 space-y-3">
                    <label for="bulk-add-input" class="block font-medium text-sm mb-1">Daftar Item Prediksi (pisahkan dengan koma)</label>
                    <textarea id="bulk-add-input" rows="8" placeholder="Jakarta, Bandung, Surabaya, ..." class="w-full bg-gray-100 border border-gray-300 rounded px-3 py-2"></textarea>
                </div>
                
                <!-- NEW: Overlay Editor Section -->
                <div class="p-4 border-t border-gray-300 space-y-3">
                  <h3 class="font-semibold mb-2">Overlay Prediksi</h3>
                  
                  <div id="overlay-editor-container" class="relative w-full border border-gray-300 rounded bg-gray-200 overflow-hidden flex items-center justify-center">
                    <img id="overlay-base-image" src="https://placehold.co/600x400/e2e8f0/64748b?text=Pilih+Gambar" alt="Preview" class="max-w-full max-h-full block object-contain">
                    <div id="overlay-text" class="absolute font-bold text-black cursor-move" style="font-size: 24px;">
                      Contoh Teks
                    </div>
                  </div>
                  
                  <div class="grid grid-cols-2 gap-x-4 gap-y-2 text-sm">
                    <div class="col-span-2">
                        <label for="overlay-image-upload" class="block w-full text-center bg-gray-600 text-white py-2 px-4 rounded hover:bg-gray-500 transition-colors cursor-pointer">
                            Pilih Gambar Latar
                        </label>
                        <input type="file" id="overlay-image-upload" accept="image/*" class="hidden">
                    </div>

                    <div class="col-span-2">
                      <label for="overlay-input" class="block font-medium">Teks Overlay (Default)</label>
                      <input type="text" id="overlay-input" placeholder="Tulis teks overlay" class="w-full border px-3 py-2 rounded bg-gray-100">
                    </div>
                    
                    <div>
                        <label for="overlay-font-size" class="block font-medium">Ukuran</label>
                        <input type="range" id="overlay-font-size" min="10" max="100" value="24" class="w-full">
                    </div>
                    <div>
                        <label for="overlay-rotation" class="block font-medium">Rotasi</label>
                        <input type="range" id="overlay-rotation" min="-180" max="180" value="0" class="w-full">
                    </div>

                    <div>
                        <label for="overlay-opacity" class="block font-medium">Opacity</label>
                        <input type="range" id="overlay-opacity" min="0" max="1" step="0.05" value="1" class="w-full">
                    </div>
                     <div>
                        <label for="overlay-color" class="block font-medium">Warna</label>
                        <input type="color" id="overlay-color" value="#000000" class="w-full h-8 border-none p-0 rounded cursor-pointer bg-gray-100">
                    </div>
                    
                    <div>
                        <label for="overlay-brightness" class="block font-medium">Brightness</label>
                        <input type="range" id="overlay-brightness" min="0" max="200" value="100" class="w-full">
                    </div>
                    <div>
                        <label for="overlay-contrast" class="block font-medium">Contrast</label>
                        <input type="range" id="overlay-contrast" min="0" max="200" value="100" class="w-full">
                    </div>
                  </div>
                </div>

            </div>

            <div class="p-4 border-t border-gray-300 flex-shrink-0">
                <button id="save-btn" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 px-4 rounded transition-colors">
                    Simpan Perubahan
                </button>
            </div>
        </div>
    </div>
    
    <!-- Instructions Modal -->
    <div id="instructions-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 sm:p-8 modal">
       <div class="bg-white border border-black rounded-lg shadow-xl w-full max-w-md flex flex-col text-black max-h-[90vh]">
            <div class="p-4 border-b border-gray-300 flex justify-between items-center flex-shrink-0">
                <h2 class="text-xl font-bold">Panduan</h2>
                <button id="close-instructions-modal-btn" class="p-1 rounded-full hover:bg-gray-200">
                    <img src="https://img.icons8.com/ios-filled/24/000000/delete-sign.png" alt="Tutup" class="w-5 h-5"/>
                </button>
            </div>
             <div class="p-6 space-y-4 overflow-y-auto modal-content-area">
                <div>
                    <h3 class="font-semibold text-lg mb-2">Efek</h3>
                    <p class="text-sm">Anda memulai dengan berkata, "Saya sudah punya satu prediksi di Google Maps." Setelah penonton menyebutkan satu lokasi secara bebas, Anda menunjukkan layar ponsel Anda, dan ternyata Google Maps menampilkan lokasi yang sama persis dengan yang baru saja mereka sebutkan.</p>
                </div>
                
                <div>
                    <h4 class="font-semibold text-md mt-4 mb-2">Metode Rahasia: Alur Performa</h4>
                    <ol class="list-decimal list-inside space-y-3 text-sm mt-3">
                        <li>
                            <strong>Langkah 1: Persiapan Awal</strong>
                            <p>Sebelum memulai, buka aplikasi ini. Anda akan melihat layar "Pilih Grup Prediksi" ("1-5", "6-10", dst). Ini adalah posisi siap Anda.</p>
                        </li>
                        <li>
                            <strong>Langkah 2: Dapatkan Pilihan Penonton</strong>
                            <p>Sampaikan kalimat pembuka Anda dan minta penonton untuk <strong>menyebutkan</strong> satu lokasi dari daftar yang sudah Anda siapkan.</p>
                        </li>
                        <li>
                            <strong>Langkah 3: Aksi Rahasia Anda</strong>
                            <p>Saat penonton menyebutkan pilihan mereka (misal: "Ubud"), Anda melakukan input rahasia di ponsel Anda. Jika mode "Galeri" aktif, aksi ini akan langsung menyimpan gambar prediksi ke perangkat Anda.</p>
                        </li>
                        <li>
                            <strong>Langkah 4: Revelation</strong>
                            <p>Jika menggunakan mode URL, aplikasi akan membuka tautan. Jika mode "Galeri", Anda bisa membuka galeri foto untuk menunjukkan gambar yang baru saja dibuat.</p>
                        </li>
                    </ol>
                </div>

                <div>
                    <h4 class="font-semibold text-md mt-4 mb-2">Persiapan Sebelum Tampil</h4>
                     <p class="text-sm">Tekan ikon gerigi <img src="https://img.icons8.com/ios-glyphs/16/000000/settings.png" alt="settings icon" class="inline h-4 w-4 mx-1"> untuk mengatur trik Anda:
                         <ul class="list-disc list-inside space-y-1 text-sm mt-2">
                             <li><strong>Isi Daftar Prediksi:</strong> Masukkan semua kemungkinan lokasi yang akan Anda gunakan.</li>
                             <li><strong>Pilih Mode Output:</strong> Atur apakah prediksi akan muncul di Google Maps, Google Search, Shortcut iOS atau diekspor ke Galeri.</li>
                             <li><strong>Atur Overlay:</strong> Unggah gambar latar dan sesuaikan gaya teks untuk mode Galeri.</li>
                         </ul>
                    </p>
                    <p class="text-sm mt-3 font-semibold">Berlatihlah melakukan aksi rahasia dengan cepat dan tidak terlihat. Selamat memukau penonton Anda!</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Notification Modal -->
    <div id="notification-modal" class="hidden fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-black bg-opacity-80 text-white text-center p-6 rounded-lg z-60">
        <p id="notification-text" class="font-semibold"></p>
    </div>

    <div class="absolute bottom-4 left-0 right-0 text-center italic text-xs text-gray-400 pointer-events-none">
        concepted by Heri Sanjaya
    </div>

    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => navigator.serviceWorker.register('service-worker.js'));
        }

        document.addEventListener('DOMContentLoaded', () => {
            const STORAGE_KEY = 'magicAppDataV8_GridOnly_Bali'; 

            const defaultData = {
                settings: { 
                    searchEngine: 'maps', 
                    shortcutName: '',
                },
                pages: [ 
                    { startNumber: 1, regions: ['Pantai Kuta', 'Seminyak', 'Canggu', 'Garuda Wisnu Kencana', 'Pura Uluwatu'] },
                    { startNumber: 6, regions: ['Ubud', 'Sawah Terasering Tegalalang', 'Danau Beratan Bedugul', 'Tanah Lot', 'Pantai Lovina'] },
                    { startNumber: 11, regions: ['Nusa Dua', 'Sanur', 'Jimbaran', 'Gunung Batur', 'Tirta Empul'] }
                ],
                overlaySettings: { // Default overlay settings
                    text: 'Contoh Teks',
                    fontSize: '24',
                    color: '#000000',
                    opacity: '1',
                    rotation: '0',
                    x: 0,
                    y: 0,
                    brightness: '100',
                    contrast: '100',
                    baseImage: null
                }
            };
            
            // --- Elements ---
            const clickableAreas = document.querySelectorAll('.clickable-area');
            const messageText = document.getElementById('message-text');
            const openSettingsBtn = document.getElementById('open-settings-btn');
            const settingsModal = document.getElementById('settings-modal');
            const closeSettingsModalBtn = document.getElementById('close-settings-modal-btn');
            const saveBtn = document.getElementById('save-btn');
            const openInstructionsBtn = document.getElementById('open-instructions-btn');
            const instructionsModal = document.getElementById('instructions-modal');
            const closeInstructionsModalBtn = document.getElementById('close-instructions-modal-btn');
            const searchEngineRadios = document.querySelectorAll('input[name="searchEngine"]');
            const shortcutNameContainer = document.getElementById('shortcut-name-container');
            const shortcutNameInput = document.getElementById('shortcut-name-input');
            const bulkAddInput = document.getElementById('bulk-add-input');
            const notificationModal = document.getElementById('notification-modal');
            const notificationText = document.getElementById('notification-text');
            const gridViewContainer = document.getElementById('grid-view-container');

            // --- State Variables ---
            let appData = {};
            let currentPageIndex = 0;
            let setPageIndex = 0;
            let isSetSelectionMode = true;
            let isSingleItemMode = false;

            // --- Main Functions ---
            function executeAction(regionName) {
                const { searchEngine, shortcutName } = appData.settings;
                
                if (searchEngine === 'gallery') {
                    triggerGalleryExport(regionName);
                    return;
                }

                let url = '';
                if (searchEngine === 'shortcut') {
                    if (!shortcutName) { 
                        showNotification('Nama Shortcut belum diatur!');
                        return; 
                    }
                    url = `shortcuts://run-shortcut?name=${encodeURIComponent(shortcutName)}&input=${encodeURIComponent(regionName)}`; 
                } else {
                    url = (searchEngine === 'maps') ? `https://maps.google.com/?q=${encodeURIComponent(regionName)}` : `https://www.google.com/search?q=${encodeURIComponent(regionName)}`;
                }
                openInExternalBrowser(url);
                messageText.textContent = `Membuka Prediksi: ${capitalizeFirstLetter(regionName)}`;
                messageText.classList.remove('hidden');
                setTimeout(() => messageText.classList.add('hidden'), 2500);
            }
            
            // --- Helper Functions ---
            function capitalizeFirstLetter(string) {
                if (!string) return '';
                return string.charAt(0).toUpperCase() + string.slice(1);
            }

            function openInExternalBrowser(url) {
                const a = document.createElement('a'); a.href = url; a.target = '_blank';
                a.rel = 'noopener noreferrer'; document.body.appendChild(a); a.click(); document.body.removeChild(a);
            }

            function loadDataFromStorage() {
                const storedData = localStorage.getItem(STORAGE_KEY);
                try {
                    const parsedData = JSON.parse(storedData);
                    if (parsedData && parsedData.settings && parsedData.pages) {
                        return {
                            ...defaultData,
                            ...parsedData,
                            settings: { ...defaultData.settings, ...parsedData.settings },
                            overlaySettings: { ...defaultData.overlaySettings, ...parsedData.overlaySettings }
                        };
                    }
                    return defaultData;
                } catch (e) { return defaultData; }
            }

            function saveDataToStorage() { localStorage.setItem(STORAGE_KEY, JSON.stringify(appData)); }
            
            function updateGridView() {
                if (!appData.pages || appData.pages.length === 0) return;
                isSingleItemMode = appData.pages.length === 1 && appData.pages[0].regions.length === 1;
                if (isSingleItemMode) {
                    messageText.classList.add('hidden');
                    const regionName = appData.pages[0].regions[0];
                    const singleItemHTML = `<div class="content-container w-full h-full flex items-center justify-center text-center"><span class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-black opacity-10 text-6xl sm:text-8xl font-black z-0">1</span><span class="relative z-10 font-semibold text-xl sm:text-3xl">${capitalizeFirstLetter(regionName)}</span></div>`;
                    clickableAreas.forEach(area => { area.innerHTML = singleItemHTML; });
                } else if (isSetSelectionMode) {
                    messageText.textContent = "Pilih Grup Prediksi";
                    messageText.classList.remove('hidden');
                    const setsPerPage = 5;
                    const startIndex = setPageIndex * setsPerPage;
                    clickableAreas.forEach((area, index) => {
                        const page = appData.pages[startIndex + index];
                        if (page && page.regions.length > 0) {
                            const start = page.startNumber; const end = start + page.regions.length - 1;
                             area.innerHTML = `<div class="content-container w-full h-full flex items-center justify-center text-center"><span class="relative z-10 font-black text-3xl sm:text-5xl">${start}-${end}</span></div>`;
                        } else { area.innerHTML = ''; }
                    });
                } else {
                    const currentPage = appData.pages[currentPageIndex];
                    if (!currentPage) { isSetSelectionMode = true; updateGridView(); return; }
                    messageText.classList.add('hidden');
                    clickableAreas.forEach((area, index) => {
                        const regionName = currentPage.regions[index] || '';
                        const formattedName = capitalizeFirstLetter(regionName);
                        area.innerHTML = regionName ? `<div class="content-container w-full h-full flex items-center justify-center text-center"><span class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-black opacity-10 text-6xl sm:text-8xl font-black z-0">${currentPage.startNumber + index}</span><span class="relative z-10 font-semibold text-base sm:text-xl">${formattedName}</span></div>` : '';
                    });
                }
            }
            
            function showNotification(message) {
                notificationText.innerHTML = message;
                notificationModal.classList.remove('hidden', 'opacity-0');
                setTimeout(() => {
                    notificationModal.classList.add('opacity-0');
                    setTimeout(() => notificationModal.classList.add('hidden'), 300);
                }, 2000);
            }

            function populateSettingsModal() {
                document.querySelector(`input[name="searchEngine"][value="${appData.settings.searchEngine}"]`).checked = true;
                shortcutNameInput.value = appData.settings.shortcutName || '';
                shortcutNameContainer.classList.toggle('hidden', appData.settings.searchEngine !== 'shortcut');
                const allRegions = appData.pages.flatMap(page => page.regions);
                bulkAddInput.value = allRegions.join(', ');
            }
            
            // --- Event Listeners ---
            openSettingsBtn.addEventListener('click', () => { populateSettingsModal(); settingsModal.classList.remove('hidden'); });
            closeSettingsModalBtn.addEventListener('click', () => settingsModal.classList.add('hidden'));
            openInstructionsBtn.addEventListener('click', () => instructionsModal.classList.remove('hidden'));
            closeInstructionsModalBtn.addEventListener('click', () => instructionsModal.classList.add('hidden'));
            
            searchEngineRadios.forEach(radio => radio.addEventListener('change', (e) => {
                shortcutNameContainer.classList.toggle('hidden', e.target.value !== 'shortcut');
            }));

            saveBtn.addEventListener('click', () => {
                appData.settings.searchEngine = document.querySelector('input[name="searchEngine"]:checked').value;
                appData.settings.shortcutName = shortcutNameInput.value.trim();
                
                const allRegions = bulkAddInput.value.split(',').map(item => item.trim()).filter(Boolean);
                const newPages = [];
                let currentStartNumber = 1;
                for (let i = 0; i < allRegions.length; i += 5) {
                    const pageRegions = allRegions.slice(i, i + 5)
                    newPages.push({ startNumber: currentStartNumber, regions: pageRegions });
                    currentStartNumber += pageRegions.length;
                }
                
                if (newPages.length === 0) {
                     appData.pages = [ { startNumber: 1, regions: ['Item Contoh'] } ];
                } else {
                    appData.pages = newPages;
                }

                saveOverlaySettings();
                saveDataToStorage();

                isSetSelectionMode = true; 
                setPageIndex = 0;
                updateGridView();
                settingsModal.classList.add('hidden');
                showNotification("Perubahan disimpan!");
            });

            gridViewContainer.addEventListener('click', (event) => {
                const area = event.target.closest('.clickable-area');
                if (!area) return;
                const areaIndexOnScreen = parseInt(area.dataset.index);
                let regionName;
                if (isSingleItemMode) {
                    regionName = appData.pages[0].regions[0];
                } else if (isSetSelectionMode) {
                    const actualSetIndex = (setPageIndex * 5) + areaIndexOnScreen;
                    if (appData.pages[actualSetIndex]) { 
                        currentPageIndex = actualSetIndex; 
                        isSetSelectionMode = false; 
                        changePage(); 
                    }
                    return;
                } else {
                    regionName = appData.pages[currentPageIndex]?.regions[areaIndexOnScreen];
                }
                if (regionName) executeAction(regionName);
            });

            let touchStartX = 0;
            gridViewContainer.addEventListener('touchstart', (e) => { touchStartX = e.changedTouches[0].screenX; }, { passive: true });
            gridViewContainer.addEventListener('touchend', (e) => {
                if (isSingleItemMode) return;
                const deltaX = e.changedTouches[0].screenX - touchStartX; 
                const swipeThreshold = 50;
                if (isSetSelectionMode) {
                    const maxSetPageIndex = Math.ceil(appData.pages.length / 5) - 1;
                    if (deltaX < -swipeThreshold && setPageIndex < maxSetPageIndex) { setPageIndex++; changePage(); } 
                    else if (deltaX > swipeThreshold && setPageIndex > 0) { setPageIndex--; changePage(); }
                } else {
                    if (deltaX < -swipeThreshold && currentPageIndex < appData.pages.length - 1) { currentPageIndex++; changePage(); } 
                    else if (deltaX > swipeThreshold) { isSetSelectionMode = true; setPageIndex = Math.floor(currentPageIndex / 5); changePage(); }
                }
            });

            function changePage() {
                document.querySelectorAll('.content-container').forEach(el => el.classList.add('fade-out'));
                setTimeout(() => { updateGridView(); }, 200);
            }

            // --- OVERLAY EDITOR ---
            const overlayEditorContainer = document.getElementById('overlay-editor-container');
            const overlayBaseImage = document.getElementById('overlay-base-image');
            const overlayImageUpload = document.getElementById('overlay-image-upload');
            const overlayTextEl = document.getElementById('overlay-text');
            const overlayInput = document.getElementById('overlay-input');
            const overlayFontSize = document.getElementById('overlay-font-size');
            const overlayRotation = document.getElementById('overlay-rotation');
            const overlayColor = document.getElementById('overlay-color');
            const overlayOpacity = document.getElementById('overlay-opacity');
            const overlayBrightness = document.getElementById('overlay-brightness');
            const overlayContrast = document.getElementById('overlay-contrast');
            
            // Global state for overlay position
            let xOffset = 0, yOffset = 0;

            // Drag-specific state variables
            let isDragging = false;
            let startDragX = 0, startDragY = 0;
            let startElX = 0, startElY = 0;

            function updateOverlayStyle() {
                const settings = appData.overlaySettings;
                // This function applies all styles. It uses the global xOffset/yOffset for position.
                overlayTextEl.style.transform = `translate(-50%, -50%) translate(${xOffset}px, ${yOffset}px) rotate(${settings.rotation}deg)`;
                overlayTextEl.style.fontSize = `${settings.fontSize}px`;
                overlayTextEl.style.color = settings.color;
                overlayTextEl.style.opacity = settings.opacity;
                overlayTextEl.style.filter = `brightness(${settings.brightness}%) contrast(${settings.contrast}%)`;
                overlayTextEl.textContent = settings.text;
            }

            function loadOverlaySettings() {
                const s = appData.overlaySettings || defaultData.overlaySettings;
                appData.overlaySettings = s; 
                
                if (s.baseImage) {
                    overlayBaseImage.src = s.baseImage;
                }
                
                // Update UI controls
                overlayInput.value = s.text;
                overlayFontSize.value = s.fontSize;
                overlayRotation.value = s.rotation;
                overlayColor.value = s.color;
                overlayOpacity.value = s.opacity;
                overlayBrightness.value = s.brightness;
                overlayContrast.value = s.contrast;
                
                // Load position into global state variables
                xOffset = s.x || 0;
                yOffset = s.y || 0;
                
                // Apply all styles from the loaded state
                updateOverlayStyle();
            }

            function saveOverlaySettings() {
                appData.overlaySettings = {
                    text: overlayInput.value,
                    fontSize: overlayFontSize.value,
                    color: overlayColor.value,
                    opacity: overlayOpacity.value,
                    rotation: overlayRotation.value,
                    x: xOffset, // Save current position
                    y: yOffset, // Save current position
                    brightness: overlayBrightness.value,
                    contrast: overlayContrast.value,
                    baseImage: appData.overlaySettings.baseImage // Preserve existing image
                };
            }

            function dragStart(e) {
                if (e.type === 'mousedown' && e.button !== 0) return;
                e.preventDefault();
                isDragging = true;
                
                startElX = xOffset;
                startElY = yOffset;
                
                startDragX = e.type === 'touchstart' ? e.touches[0].clientX : e.clientX;
                startDragY = e.type === 'touchstart' ? e.touches[0].clientY : e.clientY;
                
                overlayTextEl.style.cursor = 'grabbing';
                document.body.style.cursor = 'grabbing'; // Change cursor for the whole page for better UX
            }
            
            function drag(e) {
                if (!isDragging) return;
                e.preventDefault();
                
                const currentDragX = e.type === 'touchmove' ? e.touches[0].clientX : e.clientX;
                const currentDragY = e.type === 'touchmove' ? e.touches[0].clientY : e.clientY;
                
                const dx = currentDragX - startDragX;
                const dy = currentDragY - startDragY;
                
                xOffset = startElX + dx;
                yOffset = startElY + dy;
                
                // For performance, only update the transform property during the drag action
                overlayTextEl.style.transform = `translate(-50%, -50%) translate(${xOffset}px, ${yOffset}px) rotate(${appData.overlaySettings.rotation}deg)`;
            }

            function dragEnd() {
                if (!isDragging) return;
                isDragging = false;
                
                overlayTextEl.style.cursor = 'move';
                document.body.style.cursor = 'default';
                
                saveOverlaySettings(); // Save the final position
            }

            function triggerGalleryExport(text) {
    const mainCanvas = document.createElement('canvas');
    const mainCtx = mainCanvas.getContext('2d');
    const img = new Image();
    img.crossOrigin = "Anonymous";

    img.onload = () => {
        // Set canvas size to the original image dimensions
        mainCanvas.width = img.naturalWidth;
        mainCanvas.height = img.naturalHeight;

        // Draw the base image first
        mainCtx.drawImage(img, 0, 0, mainCanvas.width, mainCanvas.height);
        
        // Apply text styling
        const settings = appData.overlaySettings;
        const fontSize = parseFloat(settings.fontSize) * (mainCanvas.width / 600); // Scale based on canvas width
        
        // Set text properties
        mainCtx.font = `bold ${fontSize}px sans-serif`;
        mainCtx.fillStyle = settings.color;
        mainCtx.textAlign = 'center';
        mainCtx.textBaseline = 'middle';
        mainCtx.globalAlpha = parseFloat(settings.opacity);
        
        // Apply filters
        mainCtx.filter = `brightness(${settings.brightness}%) contrast(${settings.contrast}%)`;
        
        // Calculate position (center of image plus offsets)
        const centerX = mainCanvas.width / 2;
        const centerY = mainCanvas.height / 2;
        
        // Apply rotation and draw text
        mainCtx.save();
        mainCtx.translate(centerX + (settings.x || 0), centerY + (settings.y || 0));
        mainCtx.rotate(parseFloat(settings.rotation) * Math.PI / 180);
        mainCtx.fillText(text, 0, 0);
        mainCtx.restore();
        
        // Export the image
        const link = document.createElement('a');
        link.download = `prediksi-${text.replace(/\s+/g, '-').toLowerCase()}.png`;
        link.href = mainCanvas.toDataURL('image/png');
        link.click();
        showNotification(`"${capitalizeFirstLetter(text)}" diekspor!`);
    };
    
    img.onerror = () => {
        showNotification("Gagal memuat gambar untuk ekspor.");
    };
    
    // Start loading the image
    img.src = overlayBaseImage.src;
}

            function initializeOverlayEditor() {
                ['input', 'change'].forEach(evt => {
                    overlayInput.addEventListener(evt, () => { appData.overlaySettings.text = overlayInput.value; updateOverlayStyle(); saveOverlaySettings(); });
                    overlayFontSize.addEventListener(evt, () => { appData.overlaySettings.fontSize = overlayFontSize.value; updateOverlayStyle(); saveOverlaySettings(); });
                    overlayRotation.addEventListener(evt, () => { appData.overlaySettings.rotation = overlayRotation.value; updateOverlayStyle(); saveOverlaySettings(); });
                    overlayColor.addEventListener(evt, () => { appData.overlaySettings.color = overlayColor.value; updateOverlayStyle(); saveOverlaySettings(); });
                    overlayOpacity.addEventListener(evt, () => { appData.overlaySettings.opacity = overlayOpacity.value; updateOverlayStyle(); saveOverlaySettings(); });
                    overlayBrightness.addEventListener(evt, () => { appData.overlaySettings.brightness = overlayBrightness.value; updateOverlayStyle(); saveOverlaySettings(); });
                    overlayContrast.addEventListener(evt, () => { appData.overlaySettings.contrast = overlayContrast.value; updateOverlayStyle(); saveOverlaySettings(); });
                });

                overlayTextEl.addEventListener('mousedown', dragStart);
                overlayTextEl.addEventListener('touchstart', dragStart, { passive: false });
                document.addEventListener('mouseup', dragEnd);
                document.addEventListener('touchend', dragEnd);
                document.addEventListener('mousemove', drag);
                document.addEventListener('touchmove', drag, { passive: false });

                overlayImageUpload.addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = (event) => {
                            const base64String = event.target.result;
                            overlayBaseImage.src = base64String;
                            appData.overlaySettings.baseImage = base64String;
                            saveDataToStorage(); // Save image immediately
                            showNotification("Gambar latar diperbarui!");
                        };
                        reader.readAsDataURL(file);
                    }
                });

                loadOverlaySettings();
            }

            // --- Initial Load ---
            appData = loadDataFromStorage();
            updateGridView();
            initializeOverlayEditor();
        });
    </script>
</body>
</html>
